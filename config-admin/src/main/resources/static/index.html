<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>æ­Œæ‰‹é…ç½®ä¸­å¿ƒ</title>
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://unpkg.com/element-plus"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <style>
    body { font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', sans-serif; background-color: #f5f7fa; margin: 0; }
    .container { padding: 30px; max-width: 1200px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>
<div id="app" class="container">
  <div class="header">
    <h1>ğŸµ æ­Œæ‰‹é…ç½®ç®¡ç†åå°</h1>
    <el-button type="primary" @click="handleAdd">æ–°å¢æ­Œæ‰‹</el-button>
  </div>

  <el-card>
    <el-table :data="singerList" border style="width: 100%">
      <el-table-column prop="id" label="ID" width="80"></el-table-column>
      <el-table-column prop="name" label="æ­Œæ‰‹å§“å"></el-table-column>
      <el-table-column prop="location" label="åœ°åŒº"></el-table-column>
      <el-table-column label="æ“ä½œ" width="180">
        <template #default="scope">
          <el-button size="small" @click="handleEdit(scope.row)">ç¼–è¾‘</el-button>
          <el-button size="small" type="danger" disabled>åˆ é™¤</el-button>
        </template>
      </el-table-column>
    </el-table>
  </el-card>

  <el-dialog v-model="dialogVisible" :title="form.singer.id ? 'ç¼–è¾‘æ­Œæ‰‹' : 'æ–°å¢æ­Œæ‰‹'" width="600px">
    <el-form :model="form" label-width="80px">
      <el-divider content-position="left">åŸºæœ¬ä¿¡æ¯</el-divider>
      <el-form-item label="å§“å">
        <el-input v-model="form.singer.name"></el-input>
      </el-form-item>
      <el-form-item label="åœ°åŒº">
        <el-input v-model="form.singer.location"></el-input>
      </el-form-item>

      <el-divider content-position="left">æ­Œæ›²åˆ—è¡¨</el-divider>
      <div v-for="(song, index) in form.songs" :key="index" style="margin-bottom: 10px; display: flex; gap: 10px;">
        <el-input v-model="song.songName" placeholder="æ­Œæ›²æ ‡é¢˜" style="flex: 2"></el-input>
        <el-input v-model="song.album" placeholder="ä¸“è¾‘åç§°" style="flex: 2"></el-input>
        <el-button type="danger" @click="removeSong(index)">åˆ é™¤</el-button>
      </div>
      <el-button type="dashed" style="width: 100%; margin-top: 10px" @click="addSong">+ æ·»åŠ æ­Œæ›²</el-button>
    </el-form>
    <template #footer>
      <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
      <el-button type="primary" @click="submitForm">ä¿å­˜å¹¶å‘å¸ƒ</el-button>
    </template>
  </el-dialog>
</div>

<script>
  const { createApp, ref, onMounted } = Vue;
  const API_BASE = '/api/config/singer';

  createApp({
    setup() {
      const singerList = ref([]);
      const dialogVisible = ref(false);
      const form = ref({
        singer: { id: null, name: '', location: '' },
        songs: []
      });

      const loadList = () => {
        axios.get(`${API_BASE}/list`).then(res => {
          singerList.value = res.data.data;
        });
      };

      const handleAdd = () => {
        form.value = { singer: { id: null, name: '', location: '' }, songs: [] };
        dialogVisible.value = true;
      };

      const handleEdit = (row) => {
        console.log("æ­£åœ¨è·å–è¯¦æƒ…ï¼ŒID:", row.id);
        axios.get(`${API_BASE}/get/${row.id}`).then(res => {
          if (res.data.code === 200 && res.data.data) {
            const data = res.data.data;

            // 1. å¼ºåˆ¶èµ‹å€¼æ­Œæ‰‹åŸºæœ¬ä¿¡æ¯
            form.value.singer = { ...data.singer };

            // 2. å¼ºåˆ¶èµ‹å€¼æ­Œæ›²åˆ—è¡¨ï¼Œå¹¶åšç©ºå€¼é˜²å¾¡
            // ç¡®ä¿åç«¯è¿”å›çš„ List<Song> èƒ½å¯¹åº”åˆ° form.songs
            form.value.songs = data.songs ? [...data.songs] : [];

            // 3. æ‰“å¼€å¼¹çª—
            dialogVisible.value = true;
            console.log("å›æ˜¾æ•°æ®åŠ è½½æˆåŠŸ:", form.value);
          } else {
            ElementPlus.ElMessage.error("è·å–è¯¦æƒ…å¤±è´¥ï¼š" + (res.data.message || "æœªçŸ¥é”™è¯¯"));
          }
        }).catch(err => {
          console.error("è¯·æ±‚è¯¦æƒ…æ¥å£æŠ¥é”™:", err);
          ElementPlus.ElMessage.error("æ¥å£è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯ get æ¥å£");
        });
      };

      const addSong = () => {
        form.value.songs.push({ songName: '', album: '' });
      };

      const removeSong = (index) => {
        form.value.songs.splice(index, 1);
      };

      const submitForm = () => {
        axios.post(`${API_BASE}/save`, form.value).then(res => {
          if (res.data.code === 200) {
            ElementPlus.ElMessage.success('ä¿å­˜å¹¶å¹¿æ’­æ›´æ–°æˆåŠŸï¼');
            dialogVisible.value = false;
            loadList();
          }
        });
      };

      onMounted(loadList);

      return { singerList, dialogVisible, form, handleEdit, handleAdd, addSong, removeSong, submitForm };
    }
  }).use(ElementPlus).mount('#app');
</script>
</body>
</html>